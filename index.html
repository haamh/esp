<!DOCTYPE html>
<html lang="en">

<head>
    <title>ESP32 Health Monitor + 3D Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: transparent;
        }

        #modelContainer {
            width: 800px;
            height: 600px;
        }
    </style>
</head>

<body>
    <h2>ESP32 Health Monitor</h2>
    <button onclick="connectBluetooth()">Connect to ESP32</button>
    <p id="status">Status: Disconnected</p>

    <p>BPM: <span id="bpm">0</span></p>
    <p>Avg BPM: <span id="avgBpm">0</span></p>
    <p>Steps: <span id="steps">0</span></p>
    <p>GSR: <span id="gsr">0</span></p>

    <div id="modelContainer"></div>

    <script>
        const serviceUUID = "12345678-1234-5678-1234-56789abcdef0";
        const characteristicUUID = "abcdef01-1234-5678-1234-56789abcdef1";
        let characteristic;

        let scene, camera, renderer, loader, model, mixer, animations = {};

        function init3DModel() {
            const container = document.getElementById('modelContainer');

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 3);
            light.position.set(2, 5, 5);
            light.castShadow = true;
            scene.add(light);

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(10, 10),
                new THREE.ShadowMaterial({ opacity: 0.5 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            ground.receiveShadow = true;
            scene.add(ground);

            loader = new THREE.GLTFLoader();
            loader.load('EL2205.glb', (gltf) => {
                model = gltf.scene;
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);

                model.position.set(0, -1, 0);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        child.visible = true; // Ensure visibility
                    }
                });

                gltf.animations.forEach((clip) => {
                    animations[clip.name.toLowerCase()] = mixer.clipAction(clip);
                });

                playAnimation('idle');
                animate();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(0.016);
            renderer.render(scene, camera);
        }

        function playAnimation(name) {
            Object.values(animations).forEach(action => action.stop());
            if (animations[name]) {
                animations[name].reset().play();
                console.log(`Playing: ${name}`);
            } else {
                console.warn(`Animation '${name}' not found.`);
            }
        }

        async function connectBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [serviceUUID]
                });

                const server = await device.gatt.connect();
                document.getElementById("status").textContent = "Status: Connected";

                const service = await server.getPrimaryService(serviceUUID);
                characteristic = await service.getCharacteristic(characteristicUUID);

                characteristic.addEventListener("characteristicvaluechanged", handleData);
                await characteristic.startNotifications();
                console.log("Connected and receiving data...");
            } catch (error) {
                console.error("Bluetooth connection failed", error);
            }
        }

        function handleData(event) {
            try {
                let data = new TextDecoder().decode(event.target.value);
                let json = JSON.parse(data);

                document.getElementById("bpm").textContent = json.BPM;
                document.getElementById("avgBpm").textContent = json.AvgBPM;
                document.getElementById("steps").textContent = json.Steps;
                document.getElementById("gsr").textContent = json.GSR;

                updateAnimation(json.BPM, json.Steps, json.GSR);
            } catch (err) {
                console.error("Error parsing JSON data:", err);
            }
        }

        function updateAnimation(bpm, steps, gsr) {
            if (bpm >= 120) {
                playAnimation('run');
            } else if (bpm >= 70 && steps > 0) {
                playAnimation('jog');
            } else if (gsr > 1000) {
                playAnimation('sweat');
            } else {
                playAnimation('idle');
            }
        }

        window.onload = init3DModel;

    </script>

</body>

</html>
